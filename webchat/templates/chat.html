<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div>
                <h2>AI Agent (User: <strong>{{ username }}</strong>)</h2>
                <span id="session-name-display" class="session-name">Phiên: {{ session_id }}</span>
            </div>
            <div class="header-buttons">
                <button id="newSessionBtn" class="btn btn-secondary btn-sm">Phiên Mới</button>
                <button id="saveSessionBtn" class="btn btn-info btn-sm">Lưu Phiên</button>
                <button id="prepareRagBtn" class="btn btn-warning btn-sm" style="color: #212529; font-weight: 500;">Tinh lọc RAG</button>
                <button id="historyBtn" class="btn btn-secondary btn-sm">Lịch sử</button>
                <a href="/logout" class="btn btn-danger btn-sm">Đăng xuất</a>
            </div>
        </div>

        <div id="chat-box" class="chat-box"></div>

        <div class="chat-footer">
            <span id="token-counter">Tokens: ~0 / 8192</span>
        </div>

        <div class="chat-input-area">
            <textarea id="userInput" placeholder="Nhập câu hỏi của bạn ở đây..."></textarea>
            <button id="sendBtn">Gửi</button>
        </div>
    </div>

    <div class="modal fade" id="historyModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Lịch sử phiên chat</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">×</span>
            </button>
          </div>
          <div class="modal-body"><div id="historyList"></div></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="curationModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tinh Lọc & Đóng Góp Đơn Vị Kiến Thức</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="modal-body">
                    <div id="curation-loading" class="text-center p-5"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div><p class="mt-3">AI đang phân tích...</p></div>
                    <form id="curation-form" style="display: none;">
                        <div class="row">
                            <div class="col-md-4">
                                <h5><i class="fas fa-tags"></i> Metadata (Mô tả)</h5><hr>
                                <div class="form-group"><label>Tiêu đề (*)</label><input type="text" class="form-control" name="title" placeholder="VD: Hướng dẫn cấu hình SSL Nginx" required></div>
                                <div class="form-group"><label>Mã Hệ Thống (*)</label><input type="text" class="form-control" name="system_code" placeholder="VD: WEBSV_HA" required></div>
                                <div class="form-group"><label>Tags (phân cách ,)</label><input type="text" class="form-control" name="tags" placeholder="VD: nginx, ubuntu, ssl"></div>
                                <div class="form-group"><label>Phiên bản</label><input type="text" class="form-control" name="version" value="1.0"></div>
                                <div class="form-group"><label>Tài liệu liên quan (phân cách ,)</label><input type="text" class="form-control" name="related_docs" placeholder="VD: nginx-optimize.yml"></div>
                                <h5><i class="fas fa-server"></i> Máy chủ liên quan</h5><hr>
                                <div id="hosts-container"></div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="addHostBtn">+ Thêm máy chủ</button>
                                <div class="form-group form-check mt-4"><input type="checkbox" class="form-check-input" name="overwrite_existing"><label class="form-check-label">Ghi đè kiến thức cũ?</label></div>
                            </div>

                            <div class="col-md-8">
                                <h5><i class="fas fa-file-alt"></i> Nội dung kiến thức (*)<small class="text-muted"> (Giải thích "Tại sao?")</small></h5><hr>
                                <textarea name="content" class="form-control" rows="10" required></textarea>

                                <h5 class="mt-4"><i class="fas fa-lightbulb"></i> Kế hoạch hành động<small class="text-muted"> (Hướng dẫn "Làm gì?")</small></h5><hr>
                                <div class="form-group"><label>Tóm tắt cho Alert</label><input type="text" class="form-control" name="alert_summary" placeholder="Một câu tóm tắt cho thông báo."></div>
                                
                                <h6>Các bước kiểm tra (Investigation)</h6>
                                <div id="investigation-steps-container"></div>
                                <button type="button" class="btn btn-sm btn-outline-info mt-2" id="addInvest-step-btn">+ Thêm bước kiểm tra</button>
                                
                                <h6 class="mt-3">Kịch bản khắc phục (Remediation)</h6>
                                <div id="remediation-playbooks-container"></div>
                                <button type="button" class="btn btn-sm btn-outline-success mt-2" id="add-remediation-btn">+ Thêm kịch bản</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="submitKnowledgeBtn" disabled>Lưu Kiến Thức</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function() {
            let chatHistory = [];
            const chatBox = $('#chat-box'), userInput = $('#userInput'), tokenCounter = $('#token-counter'), sessionNameDisplay = $('#session-name-display'), contextLimit = 8192;

            function addMessage(sender, text) {
                const messageHtml = `<div class="message ${sender === 'user' ? 'user-message' : 'ai-message'}"><strong>${sender === 'user' ? 'Bạn' : 'AI'}:</strong> ${text.replace(/\n/g, '<br>')}</div>`;
                chatBox.append(messageHtml);
                chatBox.scrollTop(chatBox[0].scrollHeight);
                if (sender !== 'thinking') {
                    chatHistory.push({ role: sender === 'user' ? 'user' : 'assistant', content: text });
                }
            }

            async function sendMessage() {
                const messageText = userInput.val().trim();
                if (messageText === '') return;
                addMessage('user', messageText);
                userInput.val('').css('height', 'auto').focus();

                chatBox.append('<div class="message ai-message" id="thinking-message"><strong>AI:</strong> Đang suy nghĩ...</div>');
                chatBox.scrollTop(chatBox[0].scrollHeight);

                try {
                    const response = await fetch('/ask', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: messageText }) });
                    const data = await response.json();
                    $('#thinking-message').remove();
                    if (!response.ok) throw new Error(data.error || 'Lỗi server');
                    addMessage('ai', data.reply);
                    tokenCounter.text(`Tokens: ~${data.token_count} / ${contextLimit}`);
                } catch (error) {
                    $('#thinking-message').remove();
                    addMessage('ai', 'Lỗi: ' + error.message);
                }
            }

            $('#sendBtn').on('click', sendMessage);
            userInput.on('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }).on('input', function () { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });

            $('#newSessionBtn').on('click', async () => {
                await fetch('/new_session', { method: 'POST' });
                chatHistory = [];
                chatBox.empty();
                addMessage('ai', 'Đã bắt đầu phiên chat mới. Bạn cần giúp gì?');
                tokenCounter.text(`Tokens: ~0 / ${contextLimit}`);
                sessionNameDisplay.text('Phiên: Phiên Mới');
            });

            $('#saveSessionBtn').on('click', async () => {
                let sessionName = "";
                if (sessionNameDisplay.text().includes("Phiên Mới")) {
                    sessionName = prompt("Nhập tên cho phiên chat:", "");
                    if (sessionName === null || sessionName.trim() === "") return;
                }
                try {
                    const response = await fetch('/save_session', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_name: sessionName }) });
                    const data = await response.json();
                    if (data.status === 'success' && data.new_session_id) {
                        sessionNameDisplay.text(`Phiên: ${data.new_session_id}`);
                    }
                    alert(data.message || data.error || "Lưu phiên thành công.");
                } catch (e) { alert("Lỗi kết nối khi lưu phiên."); }
            });

            // --- LOGIC LỊCH SỬ ---
            $('#historyBtn').on('click', function() {
                $('#historyModal').modal('show');
            });

            $('#historyModal').on('show.bs.modal', function (event) {
                renderHistoryList();
            });

            async function renderHistoryList() {
                const historyList = $('#historyList');
                historyList.html('<div class="text-center p-4"><div class="spinner-border"></div></div>');
                try {
                    const response = await fetch('/history/list');
                    const sessions = await response.json();
                    if (!response.ok) throw new Error("Lỗi tải danh sách.");

                    historyList.empty();
                    if (sessions.length > 0) {
                        sessions.forEach(session => {
                            const formattedTime = new Date(session.updated_at || session.created_at).toLocaleString('vi-VN');
                            const item = $(`
                                <div class="history-item">
                                    <div class="history-item-info">
                                        <span class="history-name">${session.session_id}</span>
                                        <span class="timestamp">${formattedTime}</span>
                                    </div>
                                    <div class="history-actions">
                                        <button class="btn btn-sm btn-info rename-btn">Đổi tên</button>
                                        <button class="btn btn-sm btn-danger delete-btn">Xóa</button>
                                    </div>
                                </div>`);

                            item.find('.history-item-info').on('click', () => loadSession(session.session_id));
                            item.find('.rename-btn').on('click', (e) => { e.stopPropagation(); renameSession(session.session_id); });
                            item.find('.delete-btn').on('click', (e) => { e.stopPropagation(); deleteSession(session.session_id); });

                            historyList.append(item);
                        });
                    } else {
                        historyList.html('<div>Không có lịch sử nào.</div>');
                    }
                } catch (e) {
                    historyList.html(`<div class="alert alert-danger">Không thể tải lịch sử: ${e.message}</div>`);
                }
            }

            async function loadSession(sessionId) {
                try {
                    const response = await fetch('/history/load', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: sessionId }) });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Lỗi server');

                    chatHistory = [];
                    chatBox.empty();
                    data.history.forEach(msg => addMessage(msg.role, msg.content));

                    const totalTokens = Math.ceil(chatHistory.reduce((acc, msg) => acc + (msg.content || '').length, 0) / 4);
                    tokenCounter.text(`Tokens: ~${totalTokens} / ${contextLimit}`);
                    sessionNameDisplay.text(`Phiên: ${data.session_id}`);

                    $('#historyModal').modal('hide');
                } catch (e) {
                    alert('Lỗi khi tải phiên chat: ' + e.message);
                }
            }

            async function deleteSession(sessionId) {
                if (!confirm(`Bạn có chắc muốn xóa vĩnh viễn phiên "${sessionId}"?`)) return;
                try {
                    await fetch('/history/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: sessionId }) });
                    renderHistoryList();
                    if (sessionNameDisplay.text().includes(sessionId)) {
                        $('#newSessionBtn').click();
                    }
                } catch(e) {
                    alert("Lỗi khi xóa phiên.");
                }
            }

            async function renameSession(oldId) {
                const newName = prompt(`Nhập tên mới cho phiên "${oldId}":`, oldId);
                if (newName && newName.trim() !== "" && newName !== oldId) {
                    const response = await fetch('/history/rename', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ old_id: oldId, new_name: newName }) });
                    const data = await response.json();
                    if (data.status === 'success') {
                        if (sessionNameDisplay.text().includes(oldId)) {
                            sessionNameDisplay.text(`Phiên: ${newName}`);
                        }
                    } else {
                        alert('Lỗi: ' + data.error);
                    }
                    renderHistoryList();
                }
            }

            // --- LOGIC TINH LỌC RAG (TOÀN DIỆN) ---
            $('#prepareRagBtn').on('click', () => {
                if (chatHistory.length < 2) { alert("Chưa có đủ nội dung chat để tinh lọc."); return; }
                $('#curationModal').modal('show');
            });

            // Reset form khi modal được mở
            $('#curationModal').on('show.bs.modal', async function () {
                $('#curation-form').hide();
                $('#curation-loading').show();
                $('#curation-form')[0].reset(); // Reset tất cả các trường trong form
                $('#hosts-container, #investigation-steps-container, #remediation-playbooks-container').empty(); // Xóa các trường động
                $('#submitKnowledgeBtn').prop('disabled', true);
                
                try {
                    const response = await fetch('/prepare_rag_submission', { method: 'POST' });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Lỗi không xác định');

                    // Điền dữ liệu vào form
                    const form = $('#curation-form');
                    form.find('[name="title"]').val(data.metadata?.title || '');
                    form.find('[name="system_code"]').val(data.metadata?.system_code || '');
                    form.find('[name="tags"]').val((data.metadata?.tags || []).join(', '));
                    form.find('[name="version"]').val(data.metadata?.version || '1.0');
                    form.find('[name="related_docs"]').val((data.metadata?.related_docs || []).join(', '));
                    (data.metadata?.hosts || []).forEach(addHostInput); // Điền hosts

                    form.find('[name="content"]').val(data.content || '');
                    form.find('[name="alert_summary"]').val(data.actionable_plan?.alert_summary || '');
                    (data.actionable_plan?.investigation_steps || []).forEach(addInvestStep); // Điền investigation steps
                    (data.actionable_plan?.remediation_playbooks || []).forEach(addRemediationPlaybook); // Điền remediation playbooks
                    
                    $('#curation-loading').hide();
                    $('#curation-form').show();
                    $('#submitKnowledgeBtn').prop('disabled', false);
                } catch (error) {
                    alert('Lỗi khi chuẩn bị RAG: ' + error.message);
                    $('#curationModal').modal('hide');
                }
            });

            // Hàm thêm các trường động
            function addHostInput(host = { hostname: '', ip: '' }) {
                const el = $(`<div class="input-group mb-2 host-entry"><input type="text" class="form-control form-control-sm" name="host_hostname" placeholder="Hostname" value="${host.hostname||''}"><input type="text" class="form-control form-control-sm" name="host_ip" placeholder="IP Address" value="${host.ip||''}"><div class="input-group-append"><button class="btn btn-sm btn-outline-danger remove-btn" type="button">×</button></div></div>`);
                el.find('.remove-btn').on('click', () => el.remove()); $('#hosts-container').append(el);
            }
            function addInvestStep(step = { name: '', description: '', command: '' }) {
                const el = $(`<div class="card card-body bg-light mb-2 p-2 investigation-step"><input type="text" class="form-control form-control-sm mb-1" name="invest_name" placeholder="Tên bước (vd: check_connections)" value="${step.name||''}"><input type="text" class="form-control form-control-sm mb-1" name="invest_desc" placeholder="Mô tả" value="${step.description||''}"><input type="text" class="form-control form-control-sm" name="invest_cmd" placeholder="Câu lệnh" value="${step.command||''}"><button type="button" class="btn btn-sm btn-danger mt-1 remove-btn">Xóa</button></div>`);
                el.find('.remove-btn').on('click', () => el.remove()); $('#investigation-steps-container').append(el);
            }
            function addRemediationPlaybook(playbook = { name: '', description: '', type: 'ssh_command', target: '', allow_automation: false }) {
                const el = $(`<div class="card card-body bg-light mb-2 p-2 remediation-playbook"><input type="text" class="form-control form-control-sm mb-1" name="remedy_name" placeholder="Tên kịch bản (vd: safe_restart)" value="${playbook.name||''}"><input type="text" class="form-control form-control-sm mb-1" name="remedy_desc" placeholder="Mô tả" value="${playbook.description||''}"><input type="text" class="form-control form-control-sm" name="remedy_target" placeholder="Lệnh hoặc đường dẫn playbook" value="${playbook.target||''}"><div class="form-check mt-2"><input class="form-check-input" type="checkbox" name="remedy_auto" ${playbook.allow_automation ? 'checked' : ''}><label class="form-check-label">Cho phép tự động</label></div><button type="button" class="btn btn-sm btn-danger mt-1 remove-btn">Xóa</button></div>`);
                el.find('.remove-btn').on('click', () => el.remove()); $('#remediation-playbooks-container').append(el);
            }
            $('#addHostBtn').on('click', () => addHostInput());
            $('#addInvest-step-btn').on('click', () => addInvestStep());
            $('#add-remediation-btn').on('click', () => addRemediationPlaybook());

            // Gửi dữ liệu đã được cấu trúc
            $('#submitKnowledgeBtn').on('click', async function() {
                const form = $('#curation-form');
                const knowledgeUnit = {
                    metadata: {
                        title: form.find('[name="title"]').val().trim(),
                        system_code: form.find('[name="system_code"]').val().trim(),
                        tags: form.find('[name="tags"]').val().split(',').map(t => t.trim()).filter(Boolean),
                        version: form.find('[name="version"]').val().trim(),
                        related_docs: form.find('[name="related_docs"]').val().split(',').map(d => d.trim()).filter(Boolean),
                        overwrite_existing: form.find('[name="overwrite_existing"]').is(':checked'),
                        hosts: [],
                    },
                    content: form.find('[name="content"]').val().trim(),
                    actionable_plan: {
                        alert_summary: form.find('[name="alert_summary"]').val().trim(),
                        investigation_steps: [],
                        remediation_playbooks: [],
                    }
                };
                
                // Thu thập dữ liệu từ các trường động
                $('.host-entry').each(function() {
                    const hostname = $(this).find('[name="host_hostname"]').val().trim();
                    const ip = $(this).find('[name="host_ip"]').val().trim();
                    if(hostname || ip) knowledgeUnit.metadata.hosts.push({hostname, ip});
                });
                $('.investigation-step').each(function() {
                    const name = $(this).find('[name="invest_name"]').val().trim();
                    const description = $(this).find('[name="invest_desc"]').val().trim();
                    const command = $(this).find('[name="invest_cmd"]').val().trim();
                    if(name || description || command) knowledgeUnit.actionable_plan.investigation_steps.push({name, description, command});
                });
                $('.remediation-playbook').each(function() {
                    const name = $(this).find('[name="remedy_name"]').val().trim();
                    const description = $(this).find('[name="remedy_desc"]').val().trim();
                    const target = $(this).find('[name="remedy_target"]').val().trim();
                    const allow_automation = $(this).find('[name="remedy_auto"]').is(':checked');
                    if(name || description || target) knowledgeUnit.actionable_plan.remediation_playbooks.push({name, description, type: 'ssh_command', target, allow_automation});
                });

                if (!knowledgeUnit.metadata.title || !knowledgeUnit.metadata.system_code || !knowledgeUnit.content) {
                    alert('Lỗi: Tiêu đề, Mã Hệ Thống, và Nội dung là bắt buộc.'); return;
                }

                $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Đang lưu...');
                try {
                    const response = await fetch('/submit_rag_knowledge', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(knowledgeUnit) });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Lỗi không xác định');
                    alert(data.message);
                    $('#curationModal').modal('hide');
                } catch (error) {
                    alert('Lỗi khi lưu kiến thức: ' + error.message);
                } finally {
                    $(this).prop('disabled', false).html('Lưu Kiến Thức');
                }
            });

            // === KHỞI TẠO ===
            (function initialize() {
                const initialHistory = {{ session.get('chat_history', [])|tojson }};
                if (initialHistory && initialHistory.length > 0) {
                    chatHistory = []; chatBox.empty(); // Clear existing if any
                    initialHistory.forEach(msg => addMessage(msg.role, msg.content));
                    tokenCounter.text(`Tokens: ~${Math.ceil(initialHistory.reduce((acc, msg) => acc + msg.content.length, 0) / 4)} / ${contextLimit}`);
                } else {
                    addMessage('ai', 'Chào bạn, tôi có thể giúp gì cho bạn hôm nay?');
                }
            })();
        });
    </script>
</body>
</html>
