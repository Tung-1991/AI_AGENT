<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div>
                <h2>AI Agent (User: <strong>{{ username }}</strong>)</h2>
                <span id="session-name-display" class="session-name">Phiên: {{ session_id }}</span>
            </div>
            <div class="header-buttons">
                <button id="newSessionBtn">Phiên Mới</button>
                <button id="saveSessionBtn">Lưu Phiên</button>
                <button id="ragSaveBtn">Góp ý RAG</button>
                <button id="historyBtn">Lịch sử</button>
                <a href="/logout">Đăng xuất</a>
            </div>
        </div>

        <div id="chat-box" class="chat-box">
             </div>

        <div class="chat-footer">
            <span id="token-counter">Tokens: ~0 / 8192</span>
        </div>

        <div class="chat-input-area">
            <textarea id="userInput" placeholder="Nhập câu hỏi của bạn ở đây..."></textarea>
            <button id="sendBtn">Gửi</button>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Lịch sử phiên chat</h2>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const newSessionBtn = document.getElementById('newSessionBtn');
        const saveSessionBtn = document.getElementById('saveSessionBtn');
        const ragSaveBtn = document.getElementById('ragSaveBtn');
        const historyBtn = document.getElementById('historyBtn');
        const historyModal = document.getElementById('historyModal');
        const historyList = document.getElementById('historyList');
        const closeBtn = document.querySelector('.close-btn');
        const tokenCounter = document.getElementById('token-counter');
        const sessionNameDisplay = document.getElementById('session-name-display');

        // --- Core Chat Functions ---
        function addMessage(sender, text) {
            const messageElement = document.createElement('div');
            // Sử dụng class user-message và ai-message để tương thích với CSS cũ nếu cần
            messageElement.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            // Thay thế newline bằng <br> để hiển thị xuống dòng
            const formattedText = text.replace(/\n/g, '<br>');
            messageElement.innerHTML = `<strong>${sender === 'user' ? 'Bạn' : 'AI'}:</strong> ${formattedText}`;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const messageText = userInput.value.trim();
            if (messageText === '') return;

            addMessage('user', messageText);
            userInput.value = '';
            userInput.focus();

            // Hiển thị thông báo "Đang suy nghĩ..."
            const thinkingMessage = document.createElement('div');
            thinkingMessage.classList.add('message', 'ai-message');
            thinkingMessage.id = 'thinking-message';
            thinkingMessage.innerHTML = '<strong>AI:</strong> Đang suy nghĩ...';
            chatBox.appendChild(thinkingMessage);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: messageText })
                });

                document.getElementById('thinking-message')?.remove();

                if (!response.ok) throw new Error('Lỗi mạng hoặc server.');

                const data = await response.json();
                addMessage('ai', data.reply);
                tokenCounter.textContent = `Tokens: ~${data.token_count} / 8192`;
            } catch (error) {
                document.getElementById('thinking-message')?.remove();
                addMessage('ai', 'Lỗi: ' + error.message);
            }
        }

        // --- Event Listeners ---
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        newSessionBtn.addEventListener('click', async () => {
            await fetch('/new_session', { method: 'POST' });
            chatBox.innerHTML = '';
            addMessage('ai', 'Đã bắt đầu phiên chat mới. Bạn cần giúp gì?');
            tokenCounter.textContent = 'Tokens: ~0 / 8192';
            sessionNameDisplay.textContent = 'Phiên: Phiên Mới';
        });

        saveSessionBtn.addEventListener('click', async () => {
            let sessionName = "";
            const currentSessionText = sessionNameDisplay.textContent;
            // Chỉ hỏi tên nếu là phiên mới
            if (currentSessionText.includes("Phiên Mới")) {
                sessionName = prompt("Nhập tên cho phiên chat:", "");
                if (sessionName === null) return; // User cancelled
            }
            
            const response = await fetch('/save_session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_name: sessionName })
            });
            const data = await response.json();
            if (data.status === 'success' && data.new_session_id) {
                sessionNameDisplay.textContent = `Phiên: ${data.new_session_id}`;
            }
            alert(data.message);
        });

        ragSaveBtn.addEventListener('click', async () => {
            if (confirm('Bạn có chắc muốn gửi phiên chat này để làm tài liệu cho AI học không?')) {
                const response = await fetch('/rag_save', { method: 'POST' });
                const data = await response.json();
                alert(data.message);
            }
        });

        historyBtn.addEventListener('click', () => {
            renderHistoryList();
            historyModal.style.display = 'block';
        });

        closeBtn.onclick = () => { historyModal.style.display = 'none'; };
        window.onclick = (event) => {
            if (event.target == historyModal) {
                historyModal.style.display = 'none';
            }
        };

        // --- History Functions ---
        async function renderHistoryList() {
            try {
                const response = await fetch('/history/list');
                if (!response.ok) throw new Error('Không thể tải lịch sử');
                const sessions = await response.json(); // API trả về mảng object [{session_id, created_at, updated_at}]
                historyList.innerHTML = '';
                if (sessions.length > 0) {
                    sessions.forEach(session => {
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        
                        // Format time, ưu tiên updated_at
                        const displayTime = session.updated_at || session.created_at;
                        const formattedTime = displayTime 
                            ? new Date(displayTime).toLocaleString('vi-VN', {
                                hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric'
                            }) : 'Không rõ';

                        item.innerHTML = `
                            <div class="history-item-info" onclick="loadSession('${session.session_id}')">
                                <span class="history-name">${session.session_id}</span>
                                <span class="timestamp">${formattedTime}</span>
                            </div>
                            <div class="history-actions">
                                <button class="rename-btn" data-id="${session.session_id}">Đổi tên</button>
                                <button class="delete-btn" data-id="${session.session_id}">Xóa</button>
                            </div>
                        `;
                        // Gán event listener sau khi tạo element
                        item.querySelector('.rename-btn').addEventListener('click', (e) => { e.stopPropagation(); renameSession(session.session_id); });
                        item.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteSession(session.session_id); });
                        
                        historyList.appendChild(item);
                    });
                } else {
                    historyList.innerHTML = '<div>Không có lịch sử nào.</div>';
                }
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        }

        async function loadSession(sessionId) {
            const response = await fetch('/history/load', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId })
            });
            const data = await response.json();
            if (data.status === 'success') {
                chatBox.innerHTML = '';
                let totalTokens = 0;
                data.history.forEach(msg => {
                    addMessage(msg.role, msg.content);
                    totalTokens += Math.ceil((msg.content || '').length / 4);
                });
                tokenCounter.textContent = `Tokens: ~${totalTokens} / 8192`;
                sessionNameDisplay.textContent = `Phiên: ${data.session_id}`;
                historyModal.style.display = 'none';
            } else {
                alert('Lỗi khi tải phiên chat.');
            }
        }

        async function deleteSession(sessionId) {
            if (confirm(`Bạn có chắc muốn xóa vĩnh viễn phiên "${sessionId}" không?`)) {
                await fetch('/history/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });
                renderHistoryList();
                if (sessionNameDisplay.textContent.includes(sessionId)) {
                    newSessionBtn.click(); // Giả lập click nút phiên mới
                }
            }
        }

        async function renameSession(oldId) {
            const newName = prompt(`Nhập tên mới cho phiên "${oldId}":`, oldId);
            if (newName && newName.trim() !== "" && newName !== oldId) {
                const response = await fetch('/history/rename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_id: oldId, new_name: newName })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    if (sessionNameDisplay.textContent.includes(oldId)) {
                        sessionNameDisplay.textContent = `Phiên: ${newName}`;
                    }
                } else {
                    alert('Lỗi: ' + data.error);
                }
                renderHistoryList();
            }
        }
        
        // --- Initialization ---
        // Load nội dung của phiên đang active nếu có, nếu không thì hiển thị chào mừng
        document.addEventListener('DOMContentLoaded', (event) => {
             const currentSessionId = "{{ session_id }}";
             if (currentSessionId && currentSessionId !== 'Phiên Mới' && currentSessionId !== 'None') {
                 loadSession(currentSessionId);
             } else {
                 addMessage('ai', 'Chào bạn, tôi có thể giúp gì cho bạn hôm nay?');
             }
        });
    </script>
</body>
</html>
